<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Azalea Golf - Análisis Profesional de Golf</title>
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="nav.css" />
    <link rel="icon" type="image/png" href="img/icono.png" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script type="module" src="auth.js"></script>
    <script src="nav.js"></script>
  </head>
  <body>
    <header class="header">
      <div class="header-container">
        <div class="logo">
          <img src="img/logo.jpg" class="logoimg" alt="Foresight Sports Logo" />
        </div>
        <nav class="nav">
          <ul class="nav-menu">
            <li class="nav-item">
              <a href="#inicio" class="nav-link">
                <i class="fas fa-home"></i>
                <span>Inicio</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="Sesiones/index.html" class="nav-link">
                <i class="fas fa-golf-ball"></i>
                <span>Mis Sesiones</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="Torneos/index.html" class="nav-link">
                <i class="fas fa-trophy"></i>
                <span>Torneos</span>
              </a>
            </li>
            <li class="nav-item nav-item-auth" id="navPerfil" style="display: none">
              <a href="perfil.html" class="nav-link">
                <i class="fas fa-user"></i>
                <span>Mi Perfil</span>
              </a>
            </li>
            <li class="nav-item">
              <a href="login.html" class="nav-link auth-button">
                <i class="fas fa-sign-in-alt"></i>
                <span>Iniciar Sesión</span>
              </a>
            </li>
          </ul>
        </nav>
        <div class="mobile-menu-toggle">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </header>

    <!-- Hero Section -->
    <section id="inicio" class="hero">
      <div class="hero-overlay"></div>
      <div class="hero-content">
        <div class="hero-text">
          <h1 class="hero-title">
            <span class="highlight">Azalea Golf</span>
            <br />Análisis Profesional de Golf
          </h1>
          <p class="hero-subtitle">
            Revoluciona tu juego con análisis detallado de cada tiro. Descubre
            patrones, mejora tu precisión y alcanza tu máximo potencial.
          </p>
          <!-- Botones solo para invitados -->
          <div id="heroButtons" class="hero-buttons">
            <a href="register.html" class="btn btn-primary btn-lg">
              <i class="fas fa-user-plus"></i> Registrarse Gratis
            </a>
            <a href="login.html" class="btn btn-outline btn-lg">
              <i class="fas fa-sign-in-alt"></i> Iniciar Sesión
            </a>
          </div>
          <!-- Mensaje para usuarios autenticados -->
          <div
            id="heroUserMessage"
            class="hero-user-message"
            style="display: none"
          >
            <p class="hero-welcome-text">
              ¡Bienvenido de vuelta! Accede a tu dashboard personal para ver tus
              estadísticas y continuar mejorando tu juego.
            </p>
            <a href="#userDashboard" class="btn btn-primary btn-lg">
              <i class="fas fa-chart-bar"></i> Ir a Mi Dashboard
            </a>
          </div>
        </div>
        <div class="hero-stats">
          <div class="stat-item">
            <div class="stat-number">12+</div>
            <div class="stat-label">Métricas Analizadas</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">100%</div>
            <div class="stat-label">Precisión</div>
          </div>
        </div>
      </div>
    </section>

    <!-- Contenido para Invitados -->
    <div id="guestContent">
      <!-- CTA Section -->
      <section class="cta-section">
        <div class="container">
          <div class="cta-content">
            <h2>¿Listo para mejorar tu juego?</h2>
            <p>
              Únete a miles de golfistas que ya están mejorando su rendimiento
              con Azalea Golf Simulator
            </p>
            <div class="cta-buttons">
              <a href="register.html" class="btn btn-primary btn-lg">
                <i class="fas fa-rocket"></i> Comenzar Ahora
              </a>
              <a href="login.html" class="btn btn-outline btn-lg">
                <i class="fas fa-play"></i> Ver Demo
              </a>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- Contenido para Usuarios Autenticados -->
    <div id="userContent" style="display: none">
      <!-- Dashboard del Usuario -->
      <section id="userDashboard" class="user-dashboard">
        <div class="container">
          <div class="dashboard-header">
            <h2>Tu Dashboard Personal</h2>
            <p class="user-welcome" id="userWelcome">Bienvenido de vuelta</p>
          </div>

          <!-- Resumen de Rendimiento -->
          <section class="performance-summary">
            <h3>Resumen de Rendimiento</h3>
            <div class="performance-cards">
              <div class="perf-card">
                <div class="perf-icon">
                  <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="perf-content">
                  <h4>Total de Sesiones</h4>
                  <div class="perf-number" id="userTotalSessions">-</div>
                </div>
              </div>
              <div class="perf-card">
                <div class="perf-icon">
                  <i class="fas fa-golf-ball"></i>
                </div>
                <div class="perf-content">
                  <h4>Total de Tiros</h4>
                  <div class="perf-number" id="userTotalShots">-</div>
                </div>
              </div>
              <div class="perf-card">
                <div class="perf-icon">
                  <i class="fas fa-clock"></i>
                </div>
                <div class="perf-content">
                  <h4>Última Sesión</h4>
                  <div class="perf-number" id="userLastSession">-</div>
                </div>
              </div>
              <div class="perf-card">
                <div class="perf-icon">
                  <i class="fas fa-trophy"></i>
                </div>
                <div class="perf-content">
                  <h4>Mejor Distancia</h4>
                  <div class="perf-number" id="userBestDistance">-</div>
                </div>
              </div>
            </div>
          </section>

          <!-- Handicap y Comparación con Grupo -->
          <section class="handicap-comparison-section" id="handicapComparisonSection" style="display: none;">
            <div class="handicap-summary">
              <div class="handicap-badge">
                <span class="handicap-value" id="dashboardHandicap">--</span>
                <span class="handicap-label">Handicap</span>
              </div>
              <a href="perfil.html" class="btn-edit-profile">
                <i class="fas fa-edit"></i> Editar en Perfil
              </a>
            </div>

            <h3><i class="fas fa-chart-bar"></i> Comparación con tu Grupo</h3>
            <p class="comparison-subtitle" id="comparisonSubtitle"></p>

            <div class="comparison-cards" id="comparisonCards">
              <!-- Se genera dinámicamente -->
            </div>

            <p class="comparison-info" id="comparisonInfo"></p>
          </section>

          <!-- Mensaje si no tiene handicap -->
          <section class="handicap-prompt" id="handicapPrompt" style="display: none;">
            <div class="prompt-card">
              <i class="fas fa-golf-ball"></i>
              <h3>Configura tu Handicap</h3>
              <p>Establece tu handicap para ver cómo te comparas con otros jugadores de tu nivel</p>
              <a href="perfil.html" class="btn btn-primary">Ir a Mi Perfil</a>
            </div>
          </section>

          <!-- Acceso Rápido -->
          <section class="quick-access">
            <h3>Acceso Rápido</h3>
            <div class="quick-actions">
              <a href="Sesiones/index.html" class="quick-action-card primary">
                <div class="quick-icon">
                  <i class="fas fa-chart-bar"></i>
                </div>
                <div class="quick-content">
                  <h4>Mis Sesiones</h4>
                  <p>
                    Analiza tus sesiones de práctica y estadísticas detalladas
                  </p>
                </div>
                <div class="quick-arrow">
                  <i class="fas fa-arrow-right"></i>
                </div>
              </a>
              <a href="Sesiones/index.html" class="quick-action-card">
                <div class="quick-icon">
                  <i class="fas fa-map-marked-alt"></i>
                </div>
                <div class="quick-content">
                  <h4>Mapas de Dispersión</h4>
                  <p>Visualiza patrones de tus tiros</p>
                </div>
                <div class="quick-arrow">
                  <i class="fas fa-arrow-right"></i>
                </div>
              </a>
              <a href="Sesiones/index.html" class="quick-action-card">
                <div class="quick-icon">
                  <i class="fas fa-file-pdf"></i>
                </div>
                <div class="quick-content">
                  <h4>Exportar Reportes</h4>
                  <p>Genera reportes PDF y yardage books</p>
                </div>
                <div class="quick-arrow">
                  <i class="fas fa-arrow-right"></i>
                </div>
              </a>
              <a href="Torneos/index.html" class="quick-action-card">
                <div class="quick-icon">
                  <i class="fas fa-trophy"></i>
                </div>
                <div class="quick-content">
                  <h4>Torneos</h4>
                  <p>Explora torneos y clasificaciones</p>
                </div>
                <div class="quick-arrow">
                  <i class="fas fa-arrow-right"></i>
                </div>
              </a>
            </div>
          </section>

          <!-- Última Actividad -->
          <section class="recent-activity">
            <h3>Actividad Reciente</h3>
            <div class="activity-list" id="activityList">
              <div class="activity-item">
                <div class="activity-icon">
                  <i class="fas fa-info-circle"></i>
                </div>
                <div class="activity-content">
                  <p>Cargando actividad reciente...</p>
                </div>
              </div>
            </div>
          </section>
        </div>
      </section>
    </div>

    <script type="module">
      import { auth } from "./auth.js";
      import {
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
      import { db, doc, getDoc, collection, getDocs } from "./db.js";

      // Función para obtener el nombre completo del usuario
      async function getUserFullName(uid) {
        const userDocRef = doc(db, "Simulador", uid);
        const userDoc = await getDoc(userDocRef);
        if (userDoc.exists()) {
          const userData = userDoc.data();
          return `${userData.nombre} ${userData.apellido}`;
        }
        return "Usuario";
      }

      // Función para cargar el resumen de rendimiento
      async function loadPerformanceSummary(uid) {
        try {
          const userDocRef = doc(db, "Simulador", uid);
          const userDoc = await getDoc(userDocRef);

          if (userDoc.exists()) {
            const userData = userDoc.data();
            const sessions = userData.Sesiones || [];

            // Calcular total de sesiones (igual que en Mis Sesiones)
            const totalSessions = sessions.length;

            // Calcular total de tiros (igual que en Mis Sesiones)
            let totalShots = 0;
            sessions.forEach((session) => {
              if (
                session &&
                session.stats &&
                session.stats.shotCount !== undefined
              ) {
                totalShots += session.stats.shotCount;
              }
            });

            // Calcular última sesión (ordenar igual que en Mis Sesiones)
            let lastSession = "-";
            if (sessions.length > 0) {
              // Ordenar sesiones por fecha (más reciente primero) - igual que en Mis Sesiones
              const sortedSessions = sessions.sort(
                (a, b) => new Date(b.fecha) - new Date(a.fecha)
              );
              const lastSessionDate = new Date(sortedSessions[0].fecha);
              lastSession = lastSessionDate.toLocaleDateString("es-ES", {
                day: "2-digit",
                month: "short",
                year: "2-digit",
              });
            }

            // Calcular mejor distancia (usar session.datos igual que en Mis Sesiones)
            let bestDistance = 0;
            sessions.forEach((session) => {
              if (session.datos && Array.isArray(session.datos)) {
                session.datos.forEach((tiro) => {
                  if (tiro && tiro["total distance (yds)"]) {
                    const distance = parseFloat(tiro["total distance (yds)"]);
                    if (!isNaN(distance) && distance > bestDistance) {
                      bestDistance = distance;
                    }
                  }
                });
              }
            });

            // Actualizar elementos del DOM
            const totalSessionsElement =
              document.getElementById("userTotalSessions");
            const totalShotsElement = document.getElementById("userTotalShots");
            const lastSessionElement =
              document.getElementById("userLastSession");
            const bestDistanceElement =
              document.getElementById("userBestDistance");

            if (totalSessionsElement) {
              totalSessionsElement.textContent =
                totalSessions > 0 ? totalSessions : "-";
            }

            if (totalShotsElement) {
              totalShotsElement.textContent = totalShots > 0 ? totalShots : "-";
            }

            if (lastSessionElement) {
              lastSessionElement.textContent = lastSession;
            }

            if (bestDistanceElement) {
              bestDistanceElement.textContent =
                bestDistance > 0 ? `${bestDistance.toFixed(1)} yds` : "-";
            }

            // Cargar actividad reciente
            loadRecentActivity(sessions);
          } else {
            // Si no existe el documento, mostrar valores por defecto
            document.getElementById("userTotalSessions").textContent = "-";
            document.getElementById("userTotalShots").textContent = "-";
            document.getElementById("userLastSession").textContent = "-";
            document.getElementById("userBestDistance").textContent = "-";
            loadRecentActivity([]);
          }
        } catch (error) {
          // En caso de error, mostrar valores por defecto
          document.getElementById("userTotalSessions").textContent = "-";
          document.getElementById("userTotalShots").textContent = "-";
          document.getElementById("userLastSession").textContent = "-";
          document.getElementById("userBestDistance").textContent = "-";
          loadRecentActivity([]);
        }
      }

      // Función para cargar actividad reciente
      function loadRecentActivity(sessions) {
        const activityList = document.getElementById("activityList");

        if (!sessions || sessions.length === 0) {
          activityList.innerHTML = `
            <div class="activity-item">
              <div class="activity-icon">
                <i class="fas fa-info-circle"></i>
              </div>
              <div class="activity-content">
                <p>No hay actividad reciente. ¡Comienza tu primera sesión!</p>
              </div>
            </div>
          `;
          return;
        }

        // Ordenar sesiones por fecha (más reciente primero)
        const sortedSessions = sessions.sort(
          (a, b) => new Date(b.fecha) - new Date(a.fecha)
        );
        const recentSessions = sortedSessions.slice(0, 3);

        activityList.innerHTML = recentSessions
          .map((session, index) => {
            const date = new Date(session.fecha).toLocaleDateString("es-ES", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
            });
            const shotCount = session.stats?.shotCount || 0;
            const sessionTime = session.stats?.sessionTime || "N/A";

            return `
            <div class="activity-item">
              <div class="activity-icon">
                <i class="fas fa-golf-ball"></i>
              </div>
              <div class="activity-content">
                <p><strong>Sesión completada</strong> - ${shotCount} tiros el ${date}</p>
                <small>Duración: ${sessionTime}</small>
              </div>
            </div>
          `;
          })
          .join("");
      }

      // Constantes para comparación de handicap
      const HANDICAP_RANGES = [
        { id: "0-5", label: "Scratch (0-5)", min: 0, max: 5 },
        { id: "6-10", label: "Bajo (6-10)", min: 6, max: 10 },
        { id: "11-15", label: "Medio-Bajo (11-15)", min: 11, max: 15 },
        { id: "16-20", label: "Medio (16-20)", min: 16, max: 20 },
        { id: "21-25", label: "Medio-Alto (21-25)", min: 21, max: 25 },
        { id: "26-30", label: "Alto (26-30)", min: 26, max: 30 },
        { id: "31-35", label: "Alto+ (31-35)", min: 31, max: 35 },
        { id: "36-40", label: "Principiante (36-40)", min: 36, max: 40 },
        { id: "41-45", label: "Principiante+ (41-45)", min: 41, max: 45 },
        { id: "46-50", label: "Iniciación (46-50)", min: 46, max: 50 },
        { id: "51+", label: "Nuevo (51+)", min: 51, max: 54 },
      ];

      const COMPARISON_METRICS = [
        {
          key: "club speed (mph)",
          label: "Velocidad Driver",
          unit: "mph",
          icon: "fa-gauge-high",
          clubFilter: "Dr",
          clubField: "club name",
          useAbsolute: false,
          higherIsBetter: true
        },
        {
          key: "angle of attack (deg)",
          label: "Ángulo de Ataque (7i)",
          unit: "°",
          icon: "fa-arrow-down",
          clubFilter: "7i",
          clubField: "club name",
          useAbsolute: false,
          higherIsBetter: null  // Depende del contexto
        },
        {
          key: "club path (deg out-in-/in-out+)",
          label: "Club Path",
          unit: "°",
          icon: "fa-route",
          clubFilter: null,
          clubField: null,
          useAbsolute: true,  // Promedio de valores absolutos
          higherIsBetter: false  // Menor desviación es mejor
        },
      ];

      function getHandicapRange(handicap) {
        return HANDICAP_RANGES.find(r => handicap >= r.min && handicap <= r.max);
      }

      // Función para cargar sección de handicap
      async function loadHandicapSection(uid) {
        try {
          const userDocRef = doc(db, "Simulador", uid);
          const userDocSnap = await getDoc(userDocRef);

          if (!userDocSnap.exists()) return;

          const userData = userDocSnap.data();
          const currentHcp = userData.handicap?.current;

          const comparisonSection = document.getElementById("handicapComparisonSection");
          const promptSection = document.getElementById("handicapPrompt");

          if (currentHcp !== null && currentHcp !== undefined) {
            // Mostrar sección de comparación
            document.getElementById("dashboardHandicap").textContent = currentHcp.toFixed(1);
            comparisonSection.style.display = "block";
            promptSection.style.display = "none";

            // Cargar comparación (pasando el UID para excluir al usuario de la comparación)
            await loadComparison(userData, currentHcp, uid);
          } else {
            // Mostrar prompt para configurar handicap
            comparisonSection.style.display = "none";
            promptSection.style.display = "block";
          }
        } catch (error) {
          console.error("Error cargando sección de handicap:", error);
        }
      }

      // Función para obtener usuarios en un rango de handicap
      async function getUsersInHandicapRange(minHcp, maxHcp, excludeUid) {
        try {
          const usersRef = collection(db, "Simulador");
          const snapshot = await getDocs(usersRef);

          return snapshot.docs
            .filter(doc => doc.id !== excludeUid) // Excluir al usuario actual
            .map(doc => ({ uid: doc.id, ...doc.data() }))
            .filter(user => {
              const hcp = user.handicap?.current;
              return hcp !== null && hcp !== undefined && hcp >= minHcp && hcp <= maxHcp;
            });
        } catch (error) {
          console.error("Error obteniendo usuarios:", error);
          return [];
        }
      }

      // Calcular métricas agregadas de un grupo de usuarios
      function calculateGroupMetrics(users, metric) {
        const allValues = [];

        users.forEach(user => {
          (user.Sesiones || []).forEach(session => {
            (session.datos || []).forEach(shot => {
              if (shot.TiroDesactivado) return;
              const clubSpeed = parseFloat(shot["club speed (mph)"]);
              if (!clubSpeed || clubSpeed >= 550 || clubSpeed <= 0) return;

              // Filtrar por palo si es necesario
              if (metric.clubFilter && metric.clubField) {
                const shotClub = shot[metric.clubField] || "";
                if (shotClub !== metric.clubFilter) return;
              }

              const value = parseFloat(shot[metric.key]);
              if (!isNaN(value)) {
                // Usar valor absoluto si la métrica lo requiere
                allValues.push(metric.useAbsolute ? Math.abs(value) : value);
              }
            });
          });
        });

        if (allValues.length === 0) return null;

        return {
          average: allValues.reduce((a, b) => a + b, 0) / allValues.length,
          count: allValues.length
        };
      }

      // Función para cargar comparación con grupo
      async function loadComparison(userData, handicap, currentUid) {
        const range = getHandicapRange(handicap);
        if (!range) return;

        document.getElementById("comparisonSubtitle").textContent = `Tu rango: ${range.label}`;

        // Calcular métricas del usuario
        const userMetrics = calculateUserMetrics(userData.Sesiones);

        // Obtener usuarios del mismo rango (excluyendo al usuario actual)
        const usersInRange = await getUsersInHandicapRange(range.min, range.max, currentUid);

        // Si no hay suficientes jugadores para comparar
        if (usersInRange.length < 1) {
          const cardsHTML = COMPARISON_METRICS.map(metric => {
            const userValue = userMetrics[metric.key];
            const displayValue = userValue !== null ? userValue.toFixed(1) : '--';

            return `
              <div class="comparison-card">
                <div class="metric-icon"><i class="fas ${metric.icon}"></i></div>
                <div class="metric-name">${metric.label}</div>
                <div class="your-value">${displayValue} ${metric.unit}</div>
                <div class="group-value">Tu promedio personal</div>
              </div>
            `;
          }).join('');

          document.getElementById("comparisonCards").innerHTML = cardsHTML;
          document.getElementById("comparisonInfo").textContent =
            `No hay otros jugadores en tu rango (${range.label}) para comparar`;
          return;
        }

        // Generar cards de comparación con datos del grupo
        const cardsHTML = COMPARISON_METRICS.map(metric => {
          const userValue = userMetrics[metric.key];
          const groupStats = calculateGroupMetrics(usersInRange, metric);

          const displayValue = userValue !== null ? userValue.toFixed(1) : '--';
          const groupAverage = groupStats?.average;
          const groupDisplay = groupAverage !== null && groupAverage !== undefined
            ? groupAverage.toFixed(1)
            : '--';

          // Calcular diferencia
          let diffHtml = '';
          if (userValue !== null && groupAverage !== null && groupAverage !== undefined) {
            const diff = userValue - groupAverage;
            const diffAbs = Math.abs(diff);

            let diffClass;

            if (metric.higherIsBetter === true) {
              // Mayor es mejor (velocidad driver)
              diffClass = diff > 0.5 ? 'positive' : (diff < -0.5 ? 'negative' : 'neutral');
            } else if (metric.higherIsBetter === false) {
              // Menor es mejor (club path - menor desviación)
              diffClass = diff < -0.5 ? 'positive' : (diff > 0.5 ? 'negative' : 'neutral');
            } else {
              // Neutro (ángulo de ataque - depende del contexto)
              diffClass = 'neutral';
            }

            const diffSign = diff > 0 ? '+' : '';
            diffHtml = `<span class="difference ${diffClass}">${diffSign}${diff.toFixed(1)}${metric.unit}</span>`;
          }

          // Info adicional según la métrica
          let metricNote = '';
          if (metric.useAbsolute) {
            metricNote = '<small class="metric-note">(desviación promedio)</small>';
          }

          return `
            <div class="comparison-card">
              <div class="metric-icon"><i class="fas ${metric.icon}"></i></div>
              <div class="metric-name">${metric.label}</div>
              ${metricNote}
              <div class="your-value">${displayValue} ${metric.unit}</div>
              <div class="group-value">Grupo: ${groupDisplay} ${metric.unit}</div>
              ${diffHtml}
            </div>
          `;
        }).join('');

        document.getElementById("comparisonCards").innerHTML = cardsHTML;
        document.getElementById("comparisonInfo").textContent =
          `Comparando con ${usersInRange.length} jugador${usersInRange.length !== 1 ? 'es' : ''} de tu rango (${range.label})`;
      }

      // Calcular métricas del usuario
      function calculateUserMetrics(sessions) {
        const metrics = {};
        const counts = {};

        COMPARISON_METRICS.forEach(metric => {
          const values = [];
          (sessions || []).forEach(session => {
            (session.datos || []).forEach(shot => {
              if (shot.TiroDesactivado) return;
              const clubSpeed = parseFloat(shot["club speed (mph)"]);
              if (!clubSpeed || clubSpeed >= 550 || clubSpeed <= 0) return;

              // Filtrar por palo si es necesario
              if (metric.clubFilter && metric.clubField) {
                const shotClub = shot[metric.clubField] || "";
                if (shotClub !== metric.clubFilter) return;
              }

              const val = parseFloat(shot[metric.key]);
              if (!isNaN(val)) {
                // Usar valor absoluto si la métrica lo requiere
                values.push(metric.useAbsolute ? Math.abs(val) : val);
              }
            });
          });

          metrics[metric.key] = values.length > 0
            ? values.reduce((a, b) => a + b, 0) / values.length
            : null;
          counts[metric.key] = values.length;
        });

        metrics.counts = counts;
        return metrics;
      }

      // Actualizar la interfaz según el estado de autenticación
      onAuthStateChanged(auth, async (user) => {
        const authButton = document.querySelector(".auth-button");
        const guestContent = document.getElementById("guestContent");
        const userContent = document.getElementById("userContent");
        const heroButtons = document.getElementById("heroButtons");
        const heroUserMessage = document.getElementById("heroUserMessage");

        if (user) {
          const nombreCompleto = await getUserFullName(user.uid);

          // Mostrar contenido para usuario autenticado
          guestContent.style.display = "none";
          userContent.style.display = "block";
          heroButtons.style.display = "none";
          heroUserMessage.style.display = "block";

          // Actualizar mensaje de bienvenida
          document.getElementById(
            "userWelcome"
          ).textContent = `Bienvenido de vuelta, ${nombreCompleto}`;

          // Cargar resumen de rendimiento usando el UID
          await loadPerformanceSummary(user.uid);

          // Cargar sección de handicap
          await loadHandicapSection(user.uid);

          // Remover mensaje de bienvenida anterior si existe
          const existingUserInfo = document.querySelector(".user-info");
          if (existingUserInfo) {
            existingUserInfo.remove();
          }

          // Crear elemento para mostrar el nombre del usuario
          const userInfo = document.createElement("span");
          userInfo.className = "user-info";
          userInfo.textContent = `Bienvenido, ${nombreCompleto}`;

          // Insertar el nombre antes del botón de cerrar sesión
          const navMenu = document.querySelector(".nav-menu");
          const authItem = authButton.closest(".nav-item");
          navMenu.insertBefore(userInfo, authItem);

          // Mostrar enlace de perfil
          const navPerfil = document.getElementById("navPerfil");
          if (navPerfil) navPerfil.style.display = "block";

          // Actualizar botón de autenticación
          authButton.innerHTML =
            '<i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span>';
          authButton.href = "#";
          authButton.classList.add("logout");

          // Configurar el botón de cerrar sesión
          authButton.addEventListener("click", async (e) => {
            e.preventDefault();
            try {
              await signOut(auth);
              window.location.href = "login.html";
            } catch (error) {
              alert("Error al cerrar sesión. Por favor, intente nuevamente.");
            }
          });
        } else {
          // Mostrar contenido para invitado
          guestContent.style.display = "block";
          userContent.style.display = "none";
          heroButtons.style.display = "block";
          heroUserMessage.style.display = "none";

          // Ocultar enlace de perfil
          const navPerfil = document.getElementById("navPerfil");
          if (navPerfil) navPerfil.style.display = "none";

          // Remover el nombre del usuario si existe
          const userInfo = document.querySelector(".user-info");
          if (userInfo) {
            userInfo.remove();
          }

          // Restaurar botón de autenticación
          authButton.innerHTML =
            '<i class="fas fa-sign-in-alt"></i><span>Iniciar Sesión</span>';
          authButton.href = "login.html";
          authButton.classList.remove("logout");
        }
      });

      // Smooth scrolling para navegación
      document.querySelectorAll('a[href^="#"]').forEach((anchor) => {
        anchor.addEventListener("click", function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute("href"));
          if (target) {
            // Si el usuario está autenticado y hace clic en "Ir a Mi Dashboard"
            if (this.getAttribute("href") === "#userDashboard") {
              // Asegurar que el contenido del usuario esté visible
              const userContent = document.getElementById("userContent");
              if (userContent.style.display === "none") {
                userContent.style.display = "block";
              }
            }

            target.scrollIntoView({
              behavior: "smooth",
              block: "start",
            });

            // Cerrar menú móvil si está abierto
            closeMobileMenu();
          }
        });
      });

      // Menú móvil
      const mobileMenuToggle = document.querySelector(".mobile-menu-toggle");
      const nav = document.querySelector(".nav");

      function toggleMobileMenu() {
        mobileMenuToggle.classList.toggle("active");
        nav.classList.toggle("active");
        document.body.style.overflow = nav.classList.contains("active")
          ? "hidden"
          : "";
      }

      function closeMobileMenu() {
        mobileMenuToggle.classList.remove("active");
        nav.classList.remove("active");
        document.body.style.overflow = "";
      }

      mobileMenuToggle.addEventListener("click", toggleMobileMenu);

      // Cerrar menú al hacer clic en un enlace
      document.querySelectorAll(".nav-link").forEach((link) => {
        link.addEventListener("click", () => {
          if (window.innerWidth <= 768) {
            closeMobileMenu();
          }
        });
      });

      // Cerrar menú al redimensionar la ventana
      window.addEventListener("resize", () => {
        if (window.innerWidth > 768) {
          closeMobileMenu();
        }
      });

      // Header scroll effect
      window.addEventListener("scroll", () => {
        const header = document.querySelector(".header");
        if (window.scrollY > 50) {
          header.classList.add("scrolled");
        } else {
          header.classList.remove("scrolled");
        }
      });
    </script>
  </body>
</html>
